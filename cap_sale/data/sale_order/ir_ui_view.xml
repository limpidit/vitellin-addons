<?xml version="1.0" encoding="UTF-8" ?>
<odoo>
    <record id="sale_order_form" model="ir.ui.view">
        <field name="name">sale.order.form.project</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="arch" type="xml">
            <xpath expr="//sheet" position="inside">
                <field name="state" invisible="1"/>
                <field name="locked" invisible="1"/>
            </xpath>

            <xpath expr="//button[@name=%(sale.action_view_sale_advance_payment_inv)d][1]" position="attributes">
                <attribute name="groups">account.group_account_invoice</attribute>
            </xpath>
            <xpath expr="//button[@name=%(sale.action_view_sale_advance_payment_inv)d][2]" position="attributes">
                <attribute name="groups">account.group_account_invoice</attribute>
            </xpath>

            <xpath expr="//header" position="attributes">
                <attribute name="groups">sales_team.group_sale_salesman,account.group_account_invoice</attribute>
            </xpath>

            <button name="action_quotation_send" position="before">
                <button string="Calculer prime" name="compute_cee_prime_amount" type="object" invisible="state != 'draft'"/>
            </button>
            <button name="action_cancel" position="after">
                <button string="Générer chantier" name="generer_chantier" class="btn btn-primary" type="object"
                    invisible="state != 'sale' or generated_tasks_count != 0"
                    groups="cap_security.group_planificateur,cap_security.group_adv,cap_security.group_admin_fonc,base.group_system"/>
            </button>
            <button name="action_view_invoice" position="after">
                <button class="oe_stat_button" type="object" name="voir_chantiers" icon="fa-tasks" invisible="generated_tasks_count == 0">
                    <field string="Chantiers" name="generated_tasks_count" widget="statinfo"/>
                </button>
            </button>

            <!-- Masquer les heures sur la date du devis (champ standard) -->
            <xpath expr="//sheet//field[@name='date_order'][1]" position="attributes">
                <attribute name="widget">date</attribute>
                <attribute name="groups"></attribute>
            </xpath>
            <!-- Masquer les heures sur la date de la commande -->
            <xpath expr="//sheet//field[@name='date_order'][2]" position="attributes">
                <attribute name="widget">date</attribute>
            </xpath>

            <!-- Rendre le champ "Date devis" visible pour tous -->
            <xpath expr="//sheet//label[@for='date_order'][1]/parent::div" position="attributes">
                <attribute name="groups"></attribute>
            </xpath>
            <xpath expr="//sheet//field[@name='date_order'][1]" position="attributes">
                <attribute name="groups"></attribute>
            </xpath>

            <!-- Afficher le champ date_generation_devis uniquement lorsque le champ state n'est pas 'draft' ou 'sent' -->
            <xpath expr="//sheet//field[@name='validity_date']" position="after">
                <field name="date_generation_devis" invisible="state in ('draft','sent')" groups="base.group_no_one"/>
            </xpath>

            <field name="partner_id" position="after">
                <field name="project_id"/>
                <field name="represente_par" invisible="represente_par == False"/>
                <field name="date_visite_technique" invisible="date_visite_technique == False"/>
            </field>

            <field name="payment_term_id" position="after">
                <field name="cee_financial" invisible="project_id == False"/>
                <field name="oblige_id" invisible="cee_financial == False" required="cee_financial == True"
                    context="{'default_is_oblige': True, 'default_is_company': True}"/>
            </field>


            <!-- Rajouter la surface pour différencier de la quantité -->
            <xpath expr="//notebook/page[@name='order_lines']//tree//field[@name='product_uom_qty']" position="before">
                <field name="isolant_alternative_id" invisible="1"/>
                <field name="surface_m2" optional="show"/>
                <field name="resistance_thermique" optional="show" readonly="not isolant_alternative_id"/>
            </xpath>
            <xpath expr="//notebook/page[@name='order_lines']//tree//field[@name='price_unit']" position="before">
                <field name="prix_surfacique_readonly" invisible="1" />
                <field name="prix_catalogue" optional="show" />
                <field name="prix_surfacique" optional="show" readonly="prix_surfacique_readonly"/>
            </xpath>
            
            <group name="sale_total" position="inside">
                <field name="marge_brute_1" widget="monetary" class="oe_subtotal_footer" options="{'currency_field': 'currency_id'}" groups="base.group_no_one"/>
                <field name="marge_brute_1_percentage" string="Marge brute 1" widget="percentage" class="oe_subtotal_footer" options="{'currency_field': 'currency_id'}" groups="sales_team.group_sale_salesman"/>
                <field name="marge_brute_2" widget="monetary" class="oe_subtotal_footer" options="{'currency_field': 'currency_id'}" groups="base.group_no_one"/>
                <field name="marge_brute_2_percentage" string="Marge brute 2" widget="percentage" class="oe_subtotal_footer" options="{'currency_field': 'currency_id'}" groups="sales_team.group_sale_salesman"/>
            </group>
        </field>
    </record>

    <record id="sale_order_tree_readonly" model="ir.ui.view">
        <field name="name">sale.order.tree.project.readonly</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_tree"/>
        <field name="mode">primary</field>
        <field name="arch" type="xml">
            <xpath expr="//tree" position="attributes">
                <attribute name="create">0</attribute>
            </xpath>
        </field>
    </record>

    <record id="sale_order_form_readonly" model="ir.ui.view">
        <field name="name">sale.order.form.project.readonly</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="mode">primary</field>
        <field name="arch" type="xml">
            <xpath expr="//form" position="attributes">
                <attribute name="create">0</attribute>
            </xpath>

            <xpath expr="//div[@name='button_box']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
        </field>
    </record>

    <record id="view_quotation_tree" model="ir.ui.view">
            <field name="name">sale.order.tree</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_quotation_tree"/>
            <field name="arch" type="xml">
                <field name="partner_id" position="after">
                    <field name="project_id" optional="show"/>
                </field>
                <field name="amount_untaxed" position="before">
                    <field name="prime_cee_versee_client" sum="Prime CEE versée client" optional="hide"/>
                </field>
                <field name="state" position="after">
                    <field name="chantier_deja_genere" widget="boolean" optional="show"/>
                </field>
            </field>
    </record>

    <record id="view_order_tree" model="ir.ui.view">
            <field name="name">sale.order.tree</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_order_tree"/>
            <field name="arch" type="xml">
                <field name="partner_id" position="after">
                    <field name="project_id" optional="show"/>
                </field>
                <field name="invoice_status" position="before">
                    <field name="chantier_deja_genere" string="Chantier généré" widget="boolean" optional="show"/>
                </field>
            </field>
    </record>
</odoo>