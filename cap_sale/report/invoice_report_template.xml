<?xml version="1.0" encoding="UTF-8" ?>
<odoo>
    <template id="report_invoice_document" inherit_id="account.report_invoice_document">

        <!-- Ajout d'une colonne de coordonnées à gauche
        Exemple :
            Coordonnées :
                Tél : 0605040302
                Email : test@test.fr

               SIRET : 47800554900033

         -->
        <xpath expr="//div[@class='row']" position="before">
            <t t-set="information_block">
                <div>
                    <span t-field="o.sale_id.project_id.address_id.name"/>
                    <span t-if="not o.partner_id.is_company"><br/><span t-field="o.partner_id.appartenance_du_bien"/></span>
                    <span t-if="o.project_id.address_id.mobile"><br/>Tél: <span t-field="o.sale_id.project_id.address_id.mobile"/></span>
                    <span t-if="o.project_id.address_id.email"><br/>Email: <span t-field="o.sale_id.project_id.address_id.email"/></span>
                </div>
                <div t-if="o.partner_id.is_company">
                    <span t-if="o.partner_id != o.sale_id.project_id.address_id"><span t-esc="o.partner_id.name"/><br/></span>
                </div>
            </t>
        </xpath>

        <xpath expr="//div[@name='address_not_same_as_shipping']/t/address" position="before">
            <div t-if="o.sale_id.project_id.is_copro and o.sale_id.represente_par">
                <span t-esc="o.sale_id.project_id.address_id.name"/><br/>
                REPRESENTE PAR <span t-field="o.sale_id.represente_par"/>
            </div>
        </xpath>

        <xpath expr="//div[@name='address_same_as_shipping']/t/address" position="before">
            <div t-if="o.sale_id.project_id.is_copro and o.sale_id.represente_par">
                <span t-esc="o.sale_id.project_id.address_id.name"/><br/>
                REPRESENTE PAR <span t-field="o.sale_id.represente_par"/>
            </div>
        </xpath>

        <xpath expr="//div[@name='no_shipping']/t/address" position="before">
            <div t-if="o.sale_id.project_id.is_copro and o.sale_id.represente_par">
                <span t-esc="o.sale_id.project_id.address_id.name"/><br/>
                REPRESENTE PAR <span t-field="o.sale_id.represente_par"/>
            </div>
        </xpath>

        <xpath expr="//div[hasclass('clearfix')]" position="attributes">
            <attribute name="class">mt-2 clearfix</attribute>
        </xpath>

        <!-- Ajouter la date de la visite technique et Date de début des travaux
        Exemple de rendu :
        Date visite technique:      Date début des travaux:     Date de la facture :        Origine :
        16/12/2020                  31/12/2020                  31/12/2020                  SO0020
        <xpath expr="//div[@id='informations']" position="after">
            <div class="row mt0 mb16" id="informations_specifiques">
                <div t-if="o.sale_id.project_id" class="col-auto mw-100 mb-2">
                    <strong>Projet:</strong>
                    <p class="m-0" t-field="o.sale_id.project_id"/>
                </div>
                <div t-if="o.sale_id.date_visite_technique" class="col-auto mw-100 mb-2">
                    <strong>Date visite technique:</strong>
                    <p class="m-0" t-field="o.sale_id.date_visite_technique" t-options="{&quot;widget&quot;: &quot;date&quot;}"/>
                </div>
                <div t-if="o.sale_id.chantier_task_ids" class="col-auto mw-100 mb-2">
                    <strong>Date début travaux:</strong>
                    <p class="m-0" t-field="o.sale_id.chantier_task_ids[0].planned_date_begin" t-options="{&quot;widget&quot;: &quot;date&quot;}"/>
                </div>
                <div t-if="o.sale_id.origin_zone_ids" class="col-auto mw-100 mb-2">
                    <strong>Type(s) de travaux:</strong>
                    <t t-set="type_travaux_ids" t-value="'\n'.join(o.sale_id.mapped('origin_zone_ids.type_travaux.name'))"/>
                    <p class="m-0" t-esc="type_travaux_ids"/>
                </div>
                <div t-if="o.sale_id.project_id.parcelle_cadastrale" class="col-auto mw-100 mb-2">
                    <strong>Parcelle cadastrale:</strong>
                    <p class="m-0" t-field="o.sale_id.project_id.parcelle_cadastrale"/>
                </div>
            </div>
        </xpath> -->
        
        <xpath expr="//div[@id='informations']" position="after">
            <div id="informations_vitellin" class="row mt-3 mb-2">
                <div t-attf-class="#{'col-auto col-3 mw-100' if report_type != 'html' else 'col'} mb-2" t-if="o.sale_id.project_id">
                    <strong>Projet:</strong>
                    <br/>
                    <span t-field="o.sale_id.project_id">Projet X</span>
                </div>
                <div t-attf-class="#{'col-auto col-3 mw-100' if report_type != 'html' else 'col'} mb-2" t-if="o.sale_id.date_visite_technique">
                    <strong>Date visite technique:</strong>
                    <br/>
                    <span t-field="o.sale_id.date_visite_technique" t-options="{&quot;widget&quot;: &quot;date&quot;}">16/12/2020</span>
                </div>
                <div t-attf-class="#{'col-auto col-3 mw-100' if report_type != 'html' else 'col'} mb-2" t-if="o.sale_id.chantier_task_ids and not o._is_downpayment()">
                    <strong>Date début travaux:</strong>
                    <br/>
                    <span t-field="o.sale_id.chantier_task_ids[0].planned_date_begin" t-options="{&quot;widget&quot;: &quot;date&quot;}">16/12/2020</span>
                </div>
                <div t-attf-class="#{'col-auto col-3 mw-100' if report_type != 'html' else 'col'} mb-2" t-if="o.sale_id.origin_zone_ids">
                    <strong>Type(s) de travaux:</strong>
                    <br/>
                    <t t-set="type_travaux_ids" t-value="'\n'.join(o.sale_id.mapped('origin_zone_ids.type_travaux.name'))"/>
                    <span t-esc="type_travaux_ids">Isolation</span>
                </div>
                <div t-attf-class="#{'col-auto col-3 mw-100' if report_type != 'html' else 'col'} mb-2" t-if="o.sale_id.project_id.parcelle_cadastrale">
                    <strong>Parcelle cadastrale:</strong>
                    <br/>
                    <span t-field="o.sale_id.project_id.parcelle_cadastrale">Parcelle cadastrale</span>
                </div>
            </div>
        </xpath>

        <!-- limiter l'origine à 40 caractères -->
        <xpath expr="//span[@t-field='o.invoice_origin']" position="replace">
            <span class="m-0" t-if="len(o.invoice_origin) &lt; 33" t-field="o.invoice_origin"/>
            <span t-else="" class="m-0">
                <t t-set="truncated_invoice_origin" t-value="o.invoice_origin[:32] + '...'"/>
                <span t-esc="truncated_invoice_origin"/>
            </span>
        </xpath>

        <!-- Retirer la prime CEE pour les factures client (non obligé) -->
			<!-- Modif Julie : retirer prime renov aussi -->
        <xpath expr="//tbody[hasclass('invoice_tbody')]//t[@t-set='lines']" position="after">
            <t t-if="not o.partner_id.is_oblige" t-set="lines" t-value="lines.filtered(lambda l: l.product_id != o.company_id.prime_cee_wo_tva_product_id and l.product_id != o.company_id.prime_renov_wo_tva_product_id)"/>
        </xpath>

        <xpath expr="//div[@id='total']" position="replace">
            <div id="total" class="row mt-n3" style="clear: both;">
                <div t-attf-class="#{'col-6' if report_type != 'html' else 'col-sm-7 col-md-6'} ms-auto">
                    <table class="table table-sm table-borderless avoid-page-break-inside">
                        <t t-set="tax_totals" t-value="o.tax_totals or {}"/>
                        <t t-foreach="tax_totals.get('subtotals')" t-as="subtotal">
                            <tr class="border-black o_subtotal">
                                <td><strong t-out="subtotal['name']">Sous-total</strong></td>
                                <td class="text-end">
                                    <t t-if="not o.partner_id.is_oblige and not o._is_downpayment()">
                                        <t t-set="amount_untaxed" t-value="subtotal['amount'] + o.prime_cee_versee_client + o.prime_renov_versee_client"/>
                                        <span t-esc="amount_untaxed" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                                    </t>
                                    <t t-else="">
                                        <span t-out="subtotal['formatted_amount']"/>
                                    </t>
                                </td>
                            </tr>
                            <t t-set="subtotal_to_show" t-value="subtotal['name']"/>
                            <t t-call="account.tax_groups_totals"/>
                        </t>
                        <tr class="border-black o_total">
                            <td><strong>Total</strong></td>
                            <td class="text-end">
                                <t t-if="not o.partner_id.is_oblige and not o._is_downpayment()">
                                    <t t-set="amount_total" t-value="tax_totals.get('amount_total') + o.prime_cee_versee_client + o.prime_renov_versee_client"/>
                                    <span t-esc="amount_total" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                                </t>
                                <t t-else="">
                                    <span t-out="tax_totals.get('formatted_amount_total')"/>
                                </t>
                            </td>
                        </tr>
                        <t t-if="print_with_payments">
                            <t t-if="o.payment_state != 'invoicing_legacy'">
                                <t t-set="payments_vals" t-value="o.sudo().invoice_payments_widget and o.sudo().invoice_payments_widget['content'] or []"/>
                                <t t-foreach="payments_vals" t-as="payment_vals">
                                    <tr t-if="payment_vals['is_exchange'] == 0">
                                        <td>
                                            <i class="oe_form_field text-end oe_payment_label">Payé le <t t-out="payment_vals['date']" t-options='{"widget": "date"}'>2021-09-19</t></i>
                                        </td>
                                        <td class="text-end">
                                            <span t-out="payment_vals['amount']" t-options='{"widget": "monetary", "display_currency": o.currency_id}'>20.00</span>
                                        </td>
                                    </tr>
                                </t>
                                <t t-if="len(payments_vals) > 0">
                                    <tr class="border-black fw-bold">
                                        <td>Montant du</td>
                                        <td class="text-end">
                                            <span t-field="o.amount_residual">11.05</span>
                                        </td>
                                    </tr>
                                </t>
                            </t>
                        </t>
                    </table>
                </div>
            </div>
            <div class="row" style="clear: both; page-break-inside: avoid;">
                <div class="col-12">
                    <table t-if="o.prime_cee_versee_client or o.prime_renov_versee_client" class="table table-sm table-borderless mt-2 mb-0">
                        <tbody class="invoice_tbody">
                            <t t-if="o.prime_cee_versee_client">
                                <t t-foreach="o.invoice_line_ids.filtered(lambda l: l.product_id == o.company_id.prime_cee_wo_tva_product_id)" t-as="prime_line">
                                    <tr class="border-black">
                                        <td><span style="font-size: 0.8em" t-field="prime_line.name"/></td>
                                        <td class="text-end"><span t-field="prime_line.price_subtotal" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/></td>
                                    </tr>
                                </t>
                            </t>
                            <t t-if="o.prime_renov_versee_client">
                                <t t-foreach="o.invoice_line_ids.filtered(lambda l: l.product_id == o.company_id.prime_renov_wo_tva_product_id)" t-as="prime_line">
                                    <tr class="border-black">
                                        <td><span style="font-size: 0.8em" t-field="prime_line.name"/></td>
                                        <td class="text-end"><span t-field="prime_line.price_subtotal" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/></td>
                                    </tr>
                                </t>
                            </t>
                        </tbody>
                    </table>
        
                    <table t-if="o.prime_cee_versee_client or o.prime_renov_versee_client" class="table table-sm table-borderless">
                        <tr class="border-black fw-bold" style="font-size: 1.1em;">
                            <td>Net à payer</td>
                            <td class="text-end">
                                <span t-field="o.amount_total" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </xpath>
        
        <!-- Afficher le nombre de m² et le prix/m² lorsque l'article est un isolant -->
        <xpath expr="//span[@t-field='line.quantity']/parent::td" position="replace">
            <td class="text-right" style="white-space: nowrap;">
                <span t-if="line.product_id.is_isolant or any(line.sale_line_ids.mapped('origin_line_id.isolant_alternative_id'))" t-field="line.surface_m2"/><span t-else="" t-field="line.quantity"/>
                <span t-if="line.product_id.is_isolant or any(line.sale_line_ids.mapped('origin_line_id.isolant_alternative_id'))">m²</span><span t-else="" t-field="line.product_uom_id" groups="uom.group_uom"/>
            </td>
        </xpath>
        <xpath expr="//span[@t-field='line.price_unit']" position="replace">
            <span t-if="line.product_id.is_isolant or any(line.sale_line_ids.mapped('origin_line_id.isolant_alternative_id'))" class="text-nowrap" t-field="line.prix_surfacique" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: o.currency_id}"/>
            <span t-else="" class="text-nowrap" t-field="line.price_unit" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: o.currency_id}"/>
        </xpath>

        <xpath expr="//span[@id='line_tax_ids']/parent::td" position="attributes">
            <attribute name="style">white-space: nowrap;</attribute>
        </xpath>
        
        <xpath expr="//p[@name='payment_communication']/t" position="inside">
            <br/> BIC : <span t-field="o.partner_bank_id.bank_bic" class="fw-bold"/>
        </xpath>

        <!-- Ajout d'une mention en cas d'absence de TVA -->
        <!-- <xpath expr="//div[hasclass('clearfix')]" position="before">
            <div t-if="o.amount_total == o.amount_untaxed" name="inv_mention_no_tva" style="font-size: 0.8em">
                <p>
                    Prestation exonérée de TVA par l'application d'un mécanisme d'auto liquidation de la TVA dans le
                    secteur du bâtiment selon le 2 nonies de l'article 283 du code général des impôts.
                </p>
            </div>
        </xpath> -->

        <xpath expr="//table" position="after">
            <div t-if="o.amount_total == o.amount_untaxed" name="inv_mention_no_tva" style="font-size: 0.8em">
                <p>
                    Prestation exonérée de TVA par l'application d'un mécanisme d'auto liquidation de la TVA dans le
                    secteur du bâtiment selon le 2 nonies de l'article 283 du code général des impôts.
                </p>
            </div>
        </xpath>
        
        <xpath expr="//p[@name='payment_communication']" position="attributes">
            <attribute name="style">clear: both; margin-top: 20px;</attribute>
        </xpath>
        
        <xpath expr="//p[@name='payment_communication']" position="after">
            <div id="payment_conditions_zone" class="mt-3" style="page-break-inside: avoid;">
                <p t-if="o.invoice_payment_term_id">
                    <strong>Conditions de règlement :</strong> <span t-field="o.invoice_payment_term_id.note"/>
                </p>
                <p t-if="not o.invoice_payment_term_id and o.invoice_date_due">
                    <strong>Échéance :</strong> <span t-field="o.invoice_date_due"/>
                </p>
                
                <div class="mt-4" style="font-size: 0.85em; font-style: italic; color: #444;">
                    <p t-if="o.company_id.mediateur_mention_obligatoire and not o.partner_id.is_company" 
                       t-field="o.company_id.mediateur_mention_obligatoire"/>
                </div>
            </div>
        </xpath>

        <xpath expr="//p[@name='payment_communication']" position="after">
            <p t-if="o.l10n_fr_is_company_french and o.move_type.startswith('out_') and 'on_invoice' in o.invoice_line_ids.mapped('tax_ids.tax_exigibility')" position="replace"/>
        </xpath>
        
        <xpath expr="//div[@id='right-elements']/.." position="after">
            <div>
                <!-- Ajout d'une mention obligatoire concernant la société de médiation -->
                <p t-if="o.company_id.mediateur_mention_obligatoire and not o.partner_id.is_company" style="page-break-inside: avoid;" t-field="o.company_id.mediateur_mention_obligatoire"/>
            </div>
        </xpath>
    </template>

    <!-- Supprimer la mention Option pour le paiement de la taxe d'après les débits -->
    <template id="cap_remove_l10n_fr_tax_on_debits"
              inherit_id="l10n_fr_invoice_addr.report_invoice_document">

        <xpath expr='//p[@t-if="o.l10n_fr_is_company_french and o.move_type.startswith(&apos;out_&apos;) and &apos;on_invoice&apos; in o.invoice_line_ids.mapped(&apos;tax_ids.tax_exigibility&apos;)"]'
               position="replace"/>
    </template>
</odoo>